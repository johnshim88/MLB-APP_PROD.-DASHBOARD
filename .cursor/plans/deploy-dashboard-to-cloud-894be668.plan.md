<!-- 894be668-407e-4df7-b425-6c5f1948724a e4b0a8ac-3c0f-4ff2-8e41-8a2197a96de5 -->
# 대시보드 v2 업그레이드 및 메모리 최적화 계획

## Phase 1: 현재 버전 메모리 최적화 (우선 처리)

### 1.1 백엔드 메모리 최적화

**파일**: `backend/server.py`

- **문제점**: Render 메모리 초과 발생
- **원인 분석**:
  - 엑셀 파일을 메모리에 로드
  - 캐시 데이터가 메모리에 상주
  - 워크북이 제대로 닫히지 않을 수 있음
  - 백그라운드 스레드의 메모리 누수 가능성

- **개선 사항**:

  1. `load_summary` 함수에서 워크북 명시적 닫기 보장 (context manager 사용)
  2. 캐시 데이터 크기 제한 및 압축 고려
  3. 불필요한 데이터 구조 제거 (디버그 로그 최소화)
  4. 가비지 컬렉션 강제 실행 (`gc.collect()`)
  5. 엑셀 파일 읽기 시 메모리 효율적인 방식 사용 (이미 `read_only=True` 사용 중)
  6. 백그라운드 스레드의 메모리 사용량 모니터링

### 1.2 테스트 및 배포

- 로컬에서 메모리 사용량 테스트
- Render에 배포 후 모니터링
- 메모리 사용량 감소 확인

---

## Phase 2: 새 버전 (v2) 개발

### 2.1 파일 구조 설정

**새 파일 생성**:

- `frontend/index_v2.html` - 새 버전 프론트엔드
- `backend/server_v2.py` - 새 버전 백엔드 (필요시)
- `frontend/styles_v2.css` - 새 버전 스타일 (선택사항)

**기존 파일 유지**:

- `frontend/index.html` - 현재 버전 유지
- `backend/server.py` - 현재 버전 유지

### 2.2 디자인 및 레이아웃 개선

**파일**: `frontend/index_v2.html`

#### 2.2.1 전체 디자인 시스템

- 모던한 디자인 시스템 구축 (색상 팔레트, 타이포그래피)
- 그리드 레이아웃 개선
- 카드 디자인 통일
- 애니메이션 및 트랜지션 추가

#### 2.2.2 상단 KPI 카드 개선

**요구사항**: 맨 윗줄 카드에 금주 출고 수량/스타일 수 추가

- **현재 구조**: 3개 카드 (총 목표, 현재 완료, 전체 진행률)
- **새 구조**: 5개 카드

  1. 총 목표 수량/스타일 수
  2. 금주 출고 수량 (새로 추가)
  3. 금주 출고 스타일 수 (새로 추가)
  4. 현재 출고 완료 수량/스타일 수
  5. 전체 진행률 + 주차 목표진행률 (개선)

- **백엔드 변경 필요**: 
  - 엑셀 파일에서 금주 출고 데이터 추출
  - API 응답에 `current_week_shipped_qty`, `current_week_shipped_style_count` 추가

#### 2.2.3 전체 진행률 카드 개선

**요구사항**: "주차 목표진행률" 더 크게 표시

- 현재: 작은 텍스트로 표시
- 개선: 큰 숫자로 강조 표시
- 시각적 강조 (색상, 아이콘, 애니메이션)

#### 2.2.4 전체 출고 진행률 원그래프 개선

**요구사항**: 디자인 더 예쁘게

- 그라데이션 색상 적용
- 애니메이션 효과 추가
- 중앙 텍스트 스타일 개선
- 호버 효과 추가

### 2.3 그래프 개선

**파일**: `frontend/index_v2.html`

#### 2.3.1 그래프 사이즈 일관성

**요구사항**: 화면 사이즈가 달라져도 각 그래프 사이즈 유지

- 고정 높이 설정 (`height: 400px` 등)
- `maintainAspectRatio: false` 사용
- 반응형 브레이크포인트에서도 일관된 크기 유지
- CSS Grid/Flexbox로 레이아웃 고정

#### 2.3.2 세부 복종별 현황 그래프 개선

**요구사항**:

- 숫자가 밀려 보이는 이슈 개선
- 전체 복종 한번에 보이게
- 가로 그래프로 레이아웃 변경 검토

**현재 문제점**:

- 세로 막대 그래프에서 숫자 레이블이 겹침
- 드롭다운으로 하나씩만 선택 가능

**개선 방안**:

- **옵션 1**: 가로 막대 그래프로 변경, 모든 복종 표시
- **옵션 2**: 스크롤 가능한 세로 그래프, 모든 복종 표시
- **옵션 3**: 탭/아코디언 방식으로 여러 복종 그룹 표시

**권장**: 옵션 1 (가로 막대 그래프, 모든 복종 표시)

- 레이블 공간 확보 용이
- 비교하기 쉬움
- 모바일에서도 보기 좋음

#### 2.3.3 그래프 하단 엑셀 표 추가 (검토)

**요구사항**: 각 그래프 밑에 엑셀 표 추가 고민

- **구현 방식**:
  - 접기/펼치기 가능한 테이블
  - CSV 다운로드 버튼
  - 정렬 및 필터 기능

- **고려사항**:
  - 성능 영향 (많은 데이터 시)
  - UI 복잡도 증가
  - 사용자 요구도 확인 필요

### 2.4 새로운 기능 추가

#### 2.4.1 공장별 현황 추가

**요구사항**: SUMMARY 엑셀파일부터 정비 필요

- **엑셀 파일 구조 변경 필요**:
  - 공장별 데이터 시트 추가 또는 기존 시트에 공장 컬럼 추가
  - 공장별 목표/실적 데이터 구조 정의

- **백엔드 변경**:
  - `load_summary` 함수에 공장별 데이터 추출 로직 추가
  - API 응답에 `factories` 배열 추가

- **프론트엔드 구현**:
  - 공장별 현황 차트 추가 (막대 그래프 또는 파이 차트)
  - 공장별 상세 정보 카드

#### 2.4.2 데이터 내보내기 기능

**요구사항**: 데이터 내보내기 기능 추가

- **기능**:

  1. 현재 화면 데이터를 Excel로 다운로드
  2. 현재 화면 데이터를 PDF로 다운로드
  3. 전체 데이터를 CSV로 다운로드

- **구현 방식**:
  - 프론트엔드: `jsPDF`, `xlsx` 라이브러리 사용
  - 백엔드: `/api/export/excel`, `/api/export/pdf` 엔드포인트 추가 (선택사항)

- **UI**:
  - 상단에 "내보내기" 버튼 추가
  - 드롭다운 메뉴로 형식 선택

#### 2.4.3 재단 시작 등 정보 추가 (추후)

**요구사항**: 추후 재단 시작 등 정보 추가 예정

- 엑셀 파일 구조 확장 준비
- 백엔드 API 확장 가능한 구조로 설계
- 프론트엔드 컴포넌트화하여 쉽게 추가 가능하도록

### 2.5 백엔드 API 확장

**파일**: `backend/server.py` 또는 `backend/server_v2.py`

#### 2.5.1 새로운 엔드포인트

- `/api/v2/quantity` - v2용 수량 데이터 (금주 출고 정보 포함)
- `/api/v2/style-count` - v2용 스타일수 데이터
- `/api/v2/factories` - 공장별 현황 데이터
- `/api/export/excel` - Excel 내보내기 (선택사항)
- `/api/export/pdf` - PDF 내보내기 (선택사항)

#### 2.5.2 데이터 구조 확장

```python
{
    "nations": [...],
    "items": [...],
    "categories": [...],
    "sub_categories": [...],
    "factories": [...],  # 새로 추가
    "current_week_shipped": {  # 새로 추가
        "quantity": 12345,
        "style_count": 67
    },
    "week_info": {...}
}
```

### 2.6 엑셀 파일 구조 변경 가이드

**문서화 필요**: `EXCEL_STRUCTURE_V2.md`

- 현재 구조 설명
- 변경 필요한 부분 명시
- 새 컬럼/시트 추가 방법
- 데이터 매핑 규칙

---

## 구현 순서

### Step 1: 메모리 최적화 (현재 버전)

1. `backend/server.py` 메모리 최적화
2. 테스트 및 배포
3. Render에서 메모리 사용량 확인

### Step 2: v2 기본 구조 생성

1. `frontend/index_v2.html` 생성 (기존 코드 복사)
2. 기본 디자인 시스템 적용
3. 레이아웃 구조 개선

### Step 3: KPI 카드 개선

1. 상단 카드 레이아웃 변경 (5개 카드)
2. 금주 출고 데이터 표시
3. 주차 목표진행률 강조

### Step 4: 그래프 개선

1. 그래프 사이즈 일관성 적용
2. 원그래프 디자인 개선
3. 세부 복종별 그래프 개선 (가로 막대, 전체 표시)

### Step 5: 새 기능 추가

1. 공장별 현황 (엑셀 파일 구조 확인 후)
2. 데이터 내보내기 기능

### Step 6: 테스트 및 최적화

1. 반응형 테스트
2. 성능 테스트
3. 브라우저 호환성 테스트

---

## 기술 스택

- **프론트엔드**: HTML5, CSS3, Vanilla JavaScript, Chart.js
- **백엔드**: FastAPI, Python, openpyxl
- **내보내기**: jsPDF (PDF), SheetJS/xlsx (Excel)
- **디자인**: CSS Grid, Flexbox, CSS Variables

---

## 주의사항

1. **엑셀 파일 구조 변경**: 공장별 현황, 금주 출고 데이터 추가 필요
2. **하위 호환성**: 현재 버전(`index.html`)은 그대로 유지
3. **메모리 최적화**: v2도 메모리 효율적으로 설계
4. **점진적 배포**: v2 완성 후 기존 버전 교체 예정

### To-dos

- [ ] 프로젝트 구조 정리: backend/frontend 폴더 분리 및 requirements.txt 생성
- [ ] 백엔드 메모리 최적화: 워크북 명시적 닫기, 가비지 컬렉션, 캐시 최적화
- [ ] 메모리 최적화 테스트 및 Render 배포 후 모니터링
- [ ] v2 파일 구조 생성: index_v2.html 생성 및 기본 구조 설정
- [ ] v2 디자인 시스템 구축: 색상, 타이포그래피, 레이아웃 개선
- [ ] 상단 KPI 카드 개선: 금주 출고 수량/스타일 수 추가, 주차 목표진행률 강조
- [ ] 전체 출고 진행률 원그래프 디자인 개선: 그라데이션, 애니메이션
- [ ] 그래프 사이즈 일관성 유지: 고정 높이, 반응형 대응
- [ ] 세부 복종별 그래프 개선: 가로 막대, 전체 복종 표시, 숫자 겹침 해결
- [ ] 엑셀 파일 구조 변경 가이드 문서 작성 (공장별, 금주 출고 데이터)
- [ ] 백엔드 API v2 확장: 금주 출고 데이터, 공장별 데이터 엔드포인트 추가
- [ ] 공장별 현황 기능 구현: 백엔드 데이터 추출, 프론트엔드 차트
- [ ] 데이터 내보내기 기능 구현: Excel, PDF, CSV 다운로드
- [ ] v2 테스트: 반응형, 성능, 브라우저 호환성